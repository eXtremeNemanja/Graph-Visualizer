
                    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

                    <style>
                    .node {
                    cursor: pointer;
                    }

                    .link {
                    fill: none;
                    stroke: #9ecae1;
                    stroke-width: 1.5px;
                    }
                    </style>

                    <script>

                    var current = null;
                    
                    var nodesGraph = JSON.parse("{\u0022football\u0022: {\u0022id\u0022: \u0022ID_football\u0022, \u0022attributes\u0022: [\u0022id: football\u0022, \u0022value: football\u0022]}, \u0022tennis\u0022: {\u0022id\u0022: \u0022ID_tennis\u0022, \u0022attributes\u0022: [\u0022id: tennis\u0022, \u0022value: tennis\u0022]}, \u00222\u0022: {\u0022id\u0022: \u0022ID_2\u0022, \u0022attributes\u0022: [\u0022id: 2\u0022, \u0022name: Dmitry Petelin\u0022]}, \u00226\u0022: {\u0022id\u0022: \u0022ID_6\u0022, \u0022attributes\u0022: [\u0022id: 6\u0022, \u0022name: Koichi Wakata\u0022]}, \u002210\u0022: {\u0022id\u0022: \u0022ID_10\u0022, \u0022attributes\u0022: [\u0022id: 10\u0022, \u0022name: Frank Rubio\u0022]}, \u00221\u0022: {\u0022id\u0022: \u0022ID_1\u0022, \u0022attributes\u0022: [\u0022id: 1\u0022, \u0022name: Sergey Prokopyev\u0022]}, \u0022bowling\u0022: {\u0022id\u0022: \u0022ID_bowling\u0022, \u0022attributes\u0022: [\u0022id: bowling\u0022, \u0022value: bowling\u0022]}, \u0022painting\u0022: {\u0022id\u0022: \u0022ID_painting\u0022, \u0022attributes\u0022: [\u0022id: painting\u0022, \u0022value: painting\u0022]}, \u0022singing\u0022: {\u0022id\u0022: \u0022ID_singing\u0022, \u0022attributes\u0022: [\u0022id: singing\u0022, \u0022value: singing\u0022]}, \u00224\u0022: {\u0022id\u0022: \u0022ID_4\u0022, \u0022attributes\u0022: [\u0022id: 4\u0022, \u0022name: Nicole Mann\u0022]}, \u0022cooking\u0022: {\u0022id\u0022: \u0022ID_cooking\u0022, \u0022attributes\u0022: [\u0022id: cooking\u0022, \u0022value: cooking\u0022]}, \u0022fishing\u0022: {\u0022id\u0022: \u0022ID_fishing\u0022, \u0022attributes\u0022: [\u0022id: fishing\u0022, \u0022value: fishing\u0022]}, \u0022hunting\u0022: {\u0022id\u0022: \u0022ID_hunting\u0022, \u0022attributes\u0022: [\u0022id: hunting\u0022, \u0022value: hunting\u0022]}, \u00225\u0022: {\u0022id\u0022: \u0022ID_5\u0022, \u0022attributes\u0022: [\u0022id: 5\u0022, \u0022name: Josh Cassada\u0022]}, \u0022dancing\u0022: {\u0022id\u0022: \u0022ID_dancing\u0022, \u0022attributes\u0022: [\u0022id: dancing\u0022, \u0022value: dancing\u0022]}, \u00228\u0022: {\u0022id\u0022: \u0022ID_8\u0022, \u0022attributes\u0022: [\u0022id: 8\u0022, \u0022name: Fei Junlong\u0022]}, \u00227\u0022: {\u0022id\u0022: \u0022ID_7\u0022, \u0022attributes\u0022: [\u0022id: 7\u0022, \u0022name: Anna Kikina\u0022]}, \u0022teaching\u0022: {\u0022id\u0022: \u0022ID_teaching\u0022, \u0022attributes\u0022: [\u0022id: teaching\u0022, \u0022value: teaching\u0022]}, \u0022golfing\u0022: {\u0022id\u0022: \u0022ID_golfing\u0022, \u0022attributes\u0022: [\u0022id: golfing\u0022, \u0022value: golfing\u0022]}, \u00229\u0022: {\u0022id\u0022: \u0022ID_9\u0022, \u0022attributes\u0022: [\u0022id: 9\u0022, \u0022name: Deng Qingming\u0022]}}");
                    var linksGraph = JSON.parse("[{\u0022source\u0022: 5, \u0022target\u0022: \u0022hunting\u0022}, {\u0022source\u0022: 2, \u0022target\u0022: \u0022bowling\u0022}, {\u0022source\u0022: 10, \u0022target\u0022: \u0022dancing\u0022}, {\u0022source\u0022: 6, \u0022target\u0022: 2}, {\u0022source\u0022: 10, \u0022target\u0022: \u0022painting\u0022}, {\u0022source\u0022: 5, \u0022target\u0022: \u0022fishing\u0022}, {\u0022source\u0022: 5, \u0022target\u0022: 6}, {\u0022source\u0022: 10, \u0022target\u0022: 2}, {\u0022source\u0022: 1, \u0022target\u0022: 2}, {\u0022source\u0022: 2, \u0022target\u0022: \u0022football\u0022}, {\u0022source\u0022: 2, \u0022target\u0022: 1}, {\u0022source\u0022: 8, \u0022target\u0022: \u0022teaching\u0022}, {\u0022source\u0022: 10, \u0022target\u0022: \u0022teaching\u0022}, {\u0022source\u0022: 8, \u0022target\u0022: \u0022golfing\u0022}, {\u0022source\u0022: 6, \u0022target\u0022: 4}, {\u0022source\u0022: 6, \u0022target\u0022: 10}, {\u0022source\u0022: 7, \u0022target\u0022: \u0022dancing\u0022}, {\u0022source\u0022: 4, \u0022target\u0022: \u0022cooking\u0022}, {\u0022source\u0022: 4, \u0022target\u0022: 10}, {\u0022source\u0022: 1, \u0022target\u0022: \u0022tennis\u0022}, {\u0022source\u0022: 8, \u0022target\u0022: 7}, {\u0022source\u0022: 10, \u0022target\u0022: 4}, {\u0022source\u0022: 4, \u0022target\u0022: \u0022singing\u0022}, {\u0022source\u0022: 9, \u0022target\u0022: \u0022dancing\u0022}, {\u0022source\u0022: 6, \u0022target\u0022: \u0022fishing\u0022}, {\u0022source\u0022: 1, \u0022target\u0022: \u0022football\u0022}, {\u0022source\u0022: 2, \u0022target\u0022: 6}, {\u0022source\u0022: 1, \u0022target\u0022: 10}, {\u0022source\u0022: 10, \u0022target\u0022: \u0022singing\u0022}, {\u0022source\u0022: 7, \u0022target\u0022: 8}]");

                    linksGraph.forEach(function(link) {
                    link.source = nodesGraph[link.source];
                    link.target = nodesGraph[link.target];
                });
                 d3.select('.stepper').text("1. Please choose a file and then a parser");

                    function nodeClick(el) {

                        var text = "";
                        text += "ID:" + el.id + "\n";
                        if(current != null) {
                            complexView(nodesGraph[current.id.replace("ID_", "")], '#003B73');
                        }
                        
                        var node = nodesGraph[el.id.replace("ID_", "")];
                        current = node;
                        complexView(node, "red");
                        for(var i=0;i<node.attributes.length;i++) {
                            text += node.attributes[i] + "\n";
                        }
                        id = el.id.replace("ID_", "");
                        const dynamicTreeContainer = document.getElementById('dynamic-tree');
                        const xhr = new XMLHttpRequest();
                        xhr.open('GET', `/${id};select`, true);
                        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                        xhr.onreadystatechange = function () {
                            if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                                dynamicTreeContainer.innerHTML = xhr.responseText;

                                const newToggles = dynamicTreeContainer.querySelectorAll('.node-toggle');
                                newToggles.forEach(toggle => {
                                    toggle.addEventListener('click', function (event) {
                                        event.preventDefault();
                                        const newNode = this.parentNode;
                                        toggleNode(newNode);
                                    });
                                });
                                if (document.getElementById('last-opened-node') != null) {
                                    const lastOpenedNode = document.getElementById('last-opened-node').innerHTML;
                                    element = document.getElementById(lastOpenedNode);
                                    if (element) {
                                        scrollIfNeeded(element, document.getElementById('tree'));
                                        element.classList.add("selected-item");
                                    }
                                }
                            }
                        };
                        xhr.send();

                        alert(text);
                    }

                        var force = d3.layout.force() //kreiranje force layout-a
                            .size([1000, 450]) //raspoloziv prostor za iscrtavanje
                            .nodes(d3.values(nodesGraph)) //dodaj nodove
                            .links(linksGraph) //dodaj linkove
                            .on("tick", tick) //sta treba da se desi kada su izracunate nove pozicija elemenata
                            .linkDistance(150) //razmak izmedju elemenata
                            .charge(-1500)//koliko da se elementi odbijaju
                            .gravity(0.75)
                            .start(); //pokreni izracunavanje pozicija

                        // add pan and zoom
                        var svg = d3.select('#mainView').call(d3.behavior.zoom().on("zoom", function () {
                                svg.attr("transform", " translate(" + d3.event.translate + ")" + " scale(" + d3.event.scale + ")")
                        })).append('g');

                        // add the links
                        var link = svg.selectAll('.link')
                            .data(linksGraph)
                            .enter().append('line')
                            .attr('class', 'link');

                        // add the nodes
                        var node = svg.selectAll('.node')
                            .data(force.nodes()) //add
                            .enter().append('g')
                            .attr('class', 'node')
                            .attr('id', function(d){return d.id;})
                            .on('click',function(){
                            nodeClick(this);
                            });
                        d3.selectAll('.node').each(function(d){complexView(d, '#003B73');});

                        function complexView(d, color) {
                            var length = 10;
                            for(var i=0;i<d.attributes.length;i++) {
                                if(length<d.attributes[i].length) length = d.attributes[i].length
                            }

                            var attributesNum = d.attributes.length;

                            var textSize = 12;
                            var high = 30;
                            high += (attributesNum == 0) ? textSize: attributesNum*textSize;
                            var width = length * textSize/2 + 2*textSize + 5;

                            // add rectangle
                            d3.select("g#"+d.id).append('rect').
                                attr('x',0).attr('y',0).attr('width',width).attr('height',high)
                                .attr('fill', color);

                            // add id
                            d3.select("g#"+d.id).append('text').attr('x',width/2).attr('y',10)
                            .attr('text-anchor','middle')
                            .attr('font-size',textSize).attr('font-family','Poppins')
                            .attr('fill','white').text(d.id);

                            // add divider
                            d3.select("g#"+d.id).append('line').
                            attr('x1',0).attr('y1',textSize).attr('x2',width).attr('y2',textSize)
                            .attr('stroke','gray').attr('stroke-width',2);

                            // add attributes
                            for(var i=0;i<attributesNum;i++)
                            {
                                d3.select("g#"+d.id).append('text').attr('x',0).attr('y',20+i*textSize)
                                .attr('text-anchor','start')
                                .attr('font-size',textSize).attr('font-family','Poppins')
                                .attr('fill','white').text(d.attributes[i]);
                            }
                        }

                        function tick(e) {
                            node.attr("transform", function(d) {return "translate(" + d.x + "," + d.y + ")";})
                                .call(force.drag);

                            link.attr('x1', function(d) { return d.source.x; })
                                .attr('y1', function(d) { return d.source.y; })
                                .attr('x2', function(d) { return d.target.x; })
                                .attr('y2', function(d) { return d.target.y; });
                        }

                        init();
                
                        function init() {
                            let main = d3.select("#mainView").node();

                            let observer = new MutationObserver(observer_callback);

                            observer.observe(main, {
                                subtree: true,
                                attributes: true,
                                childList: true,
                                characterData: true
                            });
                        }

                        function observer_callback() {
                            let main = d3.select("#mainView").html();
                            d3.select("#birdView").html(main);

                            let mainWidth = d3.select("#mainView").select("g").node().getBBox().width;
                            let mainHeight = d3.select("#mainView").select("g").node().getBBox().height;

                            let birdWidth = $("#birdView")[0].clientWidth;
                            let birdHeight = $("#birdView")[0].clientHeight;

                            let scaleWidth = birdWidth / mainWidth;
                            let scaleHeight = birdHeight / mainHeight;

                            let scale = 0;
                            if(scaleWidth < scaleHeight){
                                scale = scaleWidth;
                            }else{
                                scale = scaleHeight;
                            }
                            
                            let x = d3.select("#birdView").select("g").node().getBBox().x;
                            let y = d3.select("#birdView").select("g").node().getBBox().y;
                            d3.select("#birdView").select('g').attr("transform", "translate ("+[-x*scale, -y*scale]+") scale("+ scale +")");
                        }

                
                    </script>
                    